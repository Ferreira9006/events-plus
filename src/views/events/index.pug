extends ../layouts/app

block content
  // Main page container
  section(class="max-w-6xl mx-auto px-4 pt-10 pb-12 space-y-8")

    // Header: title + create button
    div(class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4")
      div
        h1(class="text-3xl font-extrabold text-slate-900 leading-tight") Eventos
        p(class="text-slate-500 mt-1") Explora eventos comunitários ativos e participa nas atividades da tua comunidade.
      if user 
        a(href="/events/create"
          class="inline-flex items-center justify-center px-4 py-2 rounded-xl text-sm font-semibold bg-blue-600 text-white hover:bg-blue-700 shadow-sm"
        ) + Criar evento
      else
        a(href="/auth/register"
          class="inline-flex items-center justify-center px-4 py-2 rounded-xl text-sm font-semibold bg-blue-600 text-white hover:bg-blue-700 shadow-sm"
        ) + Criar conta

    // Empty state when there are no events
    if !events || events.length === 0
      div(class="mt-10 rounded-2xl border border-dashed border-slate-300 bg-slate-50 px-6 py-10 text-center")
        p(class="text-lg font-semibold text-slate-700 mb-2") Ainda não existem eventos.
        p(class="text-slate-500 mb-4") Sê o primeiro a criar um evento e começar a dinamizar a comunidade.
        
        if user 
          a(
            href="/events/create"
            class="inline-flex items-center justify-center px-4 py-2 rounded-xl text-sm font-semibold bg-blue-600 text-white hover:bg-blue-700"
          ) Criar o primeiro evento
        else
          a(
            href="/auth/register"
            class="inline-flex items-center justify-center px-4 py-2 rounded-xl text-sm font-semibold bg-blue-600 text-white hover:bg-blue-700"
          ) Criar conta

    else
      div(class="grid gap-6 md:grid-cols-2")

        // Loop through events
        each event in events

          // Event card component
          article(class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm flex flex-col justify-between")
            div(class="space-y-3")

              // Title + status badge
              div(class="flex items-start justify-between gap-3")
                h2(class="text-lg font-bold text-slate-900 line-clamp-2") #{event.title}

                // Status badge with dynamic color classes
                if event.status
                  - let statusClass = 'bg-slate-100 text-slate-700';
                  if event.status === 'OPEN'
                    - statusClass = 'bg-emerald-50 text-emerald-700';
                  else if event.status === 'FULL'
                    - statusClass = 'bg-amber-50 text-amber-700';
                  else if event.status === 'CANCELLED'
                    - statusClass = 'bg-rose-50 text-rose-700';
                  else if event.status === 'FINISHED'
                    - statusClass = 'bg-slate-200 text-slate-800';

                  span(
                    class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold " + statusClass
                  ) #{event.status}

              // Short event description
              if event.description
                p(class="text-sm text-slate-600 line-clamp-3")
                  | #{event.description}

              // Event metadata: date, time, location
              dl(class="mt-2 grid grid-cols-1 gap-2 text-sm text-slate-600")
                  div(class="flex items-center gap-2")
                    span(class="text-xs font-semibold uppercase tracking-wide text-slate-400")
                      | Data:
                    span #{event.date}

                  div(class="flex items-center gap-2")
                    span(class="text-xs font-semibold uppercase tracking-wide text-slate-400")
                      | Hora:
                    span #{event.time}
                    
                  div(class="flex items-center gap-2")
                    span(class="text-xs font-semibold uppercase tracking-wide text-slate-400")
                      | Local:
                    span #{event.location}

              // Organizer + capacity info
              div(class="mt-3 flex flex-wrap items-center gap-3 text-xs text-slate-500")
                span(class="inline-flex items-center gap-1")
                  span(class="font-semibold text-slate-600") Organizado por:
                  | #{event.organizer.name}

              // Calculate participant count safely
              - let participantCount = (event.participants && event.participants.length) ? event.participants.length : 0;

              if typeof event.capacity !== 'undefined'
                span(class="inline-flex items-center gap-1")
                  | Lugares:
                  span(class="font-semibold text-slate-700")
                    | #{participantCount} / #{event.capacity}

            // Card footer with action buttons
            div(class="mt-4 flex items-center justify-between gap-3")
              a(
                href=`/events/${event._id}`
                class="text-sm font-semibold text-blue-600 hover:text-blue-700 hover:underline"
              )
                | Ver detalhes

              // Participation button logic
              if event.status === 'OPEN'
                form(method="post" action=`/events/${event._id}/participate`)
                  button(
                    type="submit"
                    class="inline-flex items-center justify-center px-3 py-1.5 rounded-lg text-xs font-semibold bg-emerald-600 text-white hover:bg-emerald-700"
                  )
                    | Participar
              else
                span(class="text-xs text-slate-400 italic")
                  | Participações indisponíveis
